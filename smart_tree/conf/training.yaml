# @package: _global_

wandb:
  project: tree
  entity: harry1576
  mode: online

fp16: True
num_epoch: 500
lr_decay: True
lr: 0.01
early_stop_epoch: 20
early_stop: True

batch_size: 16
directory: /local/UC-10/npz_4mm/
json_path: /local/smart-tree/smart_tree/conf/trees_II/split.json
voxel_size: 0.04
input_features : ['xyz']
target_features: ['radius', 'medial_direction', 'class_l']

cmap:
  - [0.450, 0.325, 0.164] # Trunk
  - [0.541, 0.670, 0.164] # Foliage


capture_output: 1


# Training dataset...
train_dataset:
  _target_: smart_tree.dataset.dataset.Dataset
  mode: train
  directory: ${directory}
  json_path: ${json_path}
  cache: True
  transform: 
    _target_ : smart_tree.model.sparse.util.sparse_voxelize
    _partial_ : True
    input_features: ${input_features}
    target_features: ${target_features}
    voxel_size: ${voxel_size}

train_data_loader:
  _target_: torch.utils.data.DataLoader
  batch_size: ${batch_size}
  drop_last: True
  pin_memory: False
  num_workers: 0
  shuffle: False
  sampler:
    _target_: torch.utils.data.RandomSampler
    replacement: True
    num_samples: 32
    data_source: ${train_dataset}
  collate_fn:
    _target_: smart_tree.model.sparse.collate.batch_collate
    _partial_: True

  dataset: ${train_dataset}

# Val dataset
validation_dataset:
  _target_: smart_tree.dataset.dataset.Dataset
  mode: validation
  directory: ${directory}
  json_path: ${json_path}
  cache: True
  transform: 
    _target_ : smart_tree.model.sparse.util.sparse_voxelize
    _partial_ : True
    input_features: ${input_features}
    target_features: ${target_features}
    voxel_size: ${voxel_size}


validation_data_loader:
  _target_: torch.utils.data.DataLoader
  batch_size: ${batch_size}
  drop_last: True
  pin_memory: False
  num_workers: 0
  shuffle: False
  collate_fn:
    _target_: smart_tree.model.sparse.collate.batch_collate
    _partial_: True

  dataset: ${train_dataset}


test_dataset:
  _target_: smart_tree.dataset.dataset.Dataset
  mode: test
  directory: ${directory}
  json_path: ${json_path}
  cache: True
  transform: 
    _target_ : smart_tree.model.sparse.util.sparse_voxelize
    _partial_ : True
    input_features: ${input_features}
    target_features: ${target_features}
    voxel_size: ${voxel_size}


test_data_loader:
  _target_: torch.utils.data.DataLoader
  batch_size: ${batch_size}
  drop_last: True
  pin_memory: False
  num_workers: 0
  shuffle: False
  collate_fn:
    _target_: smart_tree.model.sparse.collate.batch_collate
    _partial_: True

  dataset: ${train_dataset}


model:
  _target_: smart_tree.model.sparse.model.Smart_Tree
  input_channels: 3
  unet_planes: [8, 16, 32, 64]
  mlp_layers: 2
  num_classes: 2

optimizer:
  _target_: torch.optim.Adam
  lr: ${lr}

scheduler:
  _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
  mode: "min"

loss_fn:
  _target_: smart_tree.model.loss.compute_loss
  _partial_: True
  vector_class: 0
  target_radius_log: True

  radius_loss_fn:
    _target_ : smart_tree.model.loss.L1Loss
    _partial_: True

  direction_loss_fn:
    _target_: smart_tree.model.loss.cosine_similarity_loss
    _partial_: True

  class_loss_fn:
    _target_: smart_tree.model.loss.FocalLoss
    gamma: 2